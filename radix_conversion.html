<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>基数変換トレーニング（ソフトキー対応）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --card-w:360px;
    --btn-h:30px;
    --kbd-gap:6px;
  }
  body {
    font-family: "Segoe UI", "メイリオ", sans-serif;
    background: #f2f2f2;
    display: flex;
    justify-content: center;
    align-items: start;
    padding: 5px;
    min-height: 100vh;
    transition: background 0.5s;
  }
  #game {
    width: min(var(--card-w), 96vw);
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    padding: 14px;
    text-align: center;
  }
  h1 {
    font-size: 18px;
    background: #222;
    color: #fff;
    padding: 8px;
    border-radius: 8px;
    margin: 0 0 10px 0;
  }
  .top-row { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .info {
    font-size: 12px;
    color: #333;
  }
  select, label { font-size: 13px; }
  .question { margin: 12px 0 4px; font-size: 14px; }
  .number { font-size: 36px; margin: 8px 0; letter-spacing:2px; }
  .answer-row { display:flex; justify-content:center; gap:8px; align-items:center; margin-top:4px; }
  input[type="text"] {
    width: 160px;
    padding: 8px 10px;
    text-align: center;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ccc;
    -webkit-user-select: text;
  }
  #nativeToggle { font-size:12px; margin-left:6px; vertical-align:middle; }
  button.primary {
    padding: 8px 12px;
    font-size: 15px;
    border: none;
    border-radius: 8px;
    background: #2b8bd3;
    color: white;
  }
  button.secondary {
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #bbb;
    background: #fff;
  }
  .result {
    border-radius: 6px;
    padding: 10px;
    margin-top: 5px;
    background: #eee;
    font-size: 13px;
    min-height: 66px;
    text-align: left;
  }
  .effect-correct { background: #ccf2ff; animation: flash-correct 0.6s ease; }
  .effect-wrong   { background: #ffe6e6; animation: flash-wrong 0.4s ease; }
  @keyframes flash-correct { 0%{background:#9ef} 100%{background:#fff} }
  @keyframes flash-wrong   { 0%{background:#f99} 100%{background:#fff} }

  /* ソフトキーボード */
  .kbd {
    margin-top:8px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--kbd-gap);
  }
  .key {
    height: var(--btn-h);
    border-radius: 8px;
    font-size: 18px;
    border: 1px solid #cfcfcf;
    background: linear-gradient(#fff,#f6f6f6);
    display:flex; align-items:center; justify-content:center;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  .key:active { transform: translateY(1px); }
  .key.del { background: linear-gradient(#ffecec,#ffdede); border-color:#f3a3a3; }
  .key.enter { grid-column: span 2; background: linear-gradient(#2b8bd3,#1e6fb2); color:#fff; border-color:#186090; }
  .kbd .key.wide { grid-column: span 2; }

  /* レスポンシブでボタン大きめ */
  @media (max-width:420px){
    :root{ --btn-h:56px; }
    .number{ font-size:28px; }
    input[type="text"]{ width: 140px; font-size:18px; }
  }

  /* 難易度背景カラー（bodyに適用されます） */
  .easy-bg { background: #eaffea; }
  .normal-bg { background: #f0ffff; }
  .hard-bg { background: #ffe6e6; }
</style>
</head>
<body>

<div id="game">
  <h1>基数変換トレーニング</h1>

  <div class="top-row">
    <div class="info" id="stats">正答率: 0 / 0　スコア: 0</div>
    <div>
      <select id="modeSelect" title="出題モード">
        <option value="7">random</option>
        <option value="1">2→10</option>
        <option value="2">10→2</option>
        <option value="3">2→16</option>
        <option value="4">16→2</option>
        <option value="5">10→16</option>
        <option value="6">16→10</option>
      </select>
      <label style="margin-left:8px;">
        <input type="checkbox" id="levelChk"> Normalモード
      </label>
    </div>
  </div>

  <div class="question" id="questionText"></div>
  <div class="number" id="questionNum"></div>

  <div class="answer-row">
    <input type="text" id="answerInput" placeholder="答えを入力" readonly>
    <button class="primary" id="enterBtn">ENTER</button>

  </div>

  <div class="info" id="levelText">難易度: Easy</div>
      <label id="nativeToggle"><input type="checkbox" id="allowNative"> 標準キーボードの有効化</label>

  <div class="result" id="resultBox">まだ回答していません</div>

  <div class="info" style="margin-top:10px;">ibaraki Technology High School</div>

  <!-- ソフトキーボード -->
  <div class="kbd" id="softKbd" aria-hidden="false">
    <!-- 0-9 A-F, Del, Enter -->
    <div class="key" data-key="0">0</div>
    <div class="key" data-key="1">1</div>
    <div class="key" data-key="2">2</div>
    <div class="key" data-key="3">3</div>

    <div class="key" data-key="4">4</div>
    <div class="key" data-key="5">5</div>
    <div class="key" data-key="6">6</div>
    <div class="key" data-key="7">7</div>

    <div class="key" data-key="8">8</div>
    <div class="key" data-key="9">9</div>
    <div class="key" data-key="A">A</div>
    <div class="key" data-key="B">B</div>

    <div class="key" data-key="C">C</div>
    <div class="key" data-key="D">D</div>
    <div class="key" data-key="E">E</div>
    <div class="key" data-key="F">F</div>

    <div class="key del" id="delKey">Del</div>
    <div class="key wide enter" id="kbdEnter">ENTER</div>
  </div>
</div>

<script>
/* --- 既存ロジック（移植済み機能） --- */
let e_point=1,n_point=6,h_point=15;
let x, mode, level_mode=1, set_mode=7;
let score=0, correctRate=0, total=0;
let old_x=0, old_ans="", old_mode=0, old_intext="";

const qText = document.getElementById("questionText");
const qNum = document.getElementById("questionNum");
const input = document.getElementById("answerInput");
const resultBox = document.getElementById("resultBox");
const stats = document.getElementById("stats");
const levelChk = document.getElementById("levelChk");
const levelText = document.getElementById("levelText");
const modeSelect = document.getElementById("modeSelect");
const enterBtn = document.getElementById("enterBtn");
const allowNative = document.getElementById("allowNative");

init();

function init(){
  mode = Math.floor(Math.random()*6)+1;
  x_random();
  updateQuestion();
}

/* updateQuestion + background update */
function updateQuestion(){
  const questions = [
    "問）次の２進数を１０進数に変換しなさい。",
    "問）次の１０進数を２進数に変換しなさい。",
    "問）次の２進数を１６進数に変換しなさい。",
    "問）次の１６進数を２進数に変換しなさい。",
    "問）次の１０進数を１６進数に変換しなさい。",
    "問）次の１６進数を１０進数に変換しなさい。"
  ];
  qText.textContent = questions[mode-1] || "";
  if(mode==2||mode==5) qNum.textContent = x.toString(10);
  if(mode==1||mode==3) qNum.textContent = x.toString(2);
  if(mode==4||mode==6) qNum.textContent = x.toString(16).toUpperCase();
  levelText.textContent = (level_mode==1) ? "難易度: Easy" :
                          (level_mode==2) ? "難易度: Normal" : "難易度: Hard";
  updateBackground();
}

/* difficulty-based background */
function updateBackground(){
  document.body.classList.remove('easy-bg','normal-bg','hard-bg');
  if(level_mode==1) document.body.classList.add('easy-bg');
  else if(level_mode==2) document.body.classList.add('normal-bg');
  else if(level_mode==3) document.body.classList.add('hard-bg');
}

/* random number generator */
function x_random(){
  if(level_mode==1){x=intRand(2,16);}
  if(level_mode==1 && (mode==5||mode==6)){x=intRand(10,16);}
  if(level_mode==2){x=intRand(16,128);}
  if(level_mode==3){x=intRand(127,1024);}
}
function intRand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

/* compute correct answer string */
function correctAnswer(){
  switch(mode){
    case 1: return x.toString(10);
    case 2: return x.toString(2);
    case 3: return x.toString(16).toUpperCase();
    case 4: return x.toString(2);
    case 5: return x.toString(16).toUpperCase();
    case 6: return x.toString(10);
  }
}
function baseLabel(n){
  if(n===2) return "(2進数)";
  if(n===10) return "(10進数)";
  if(n===16) return "(16進数)";
}

/* judge answer using parsing (same as p5 logic) */
function judgeAnswer(){
  const ans = input.value.trim();
  old_x = x;
  old_intext = ans;
  let correct = false;
  try{
    if(mode==1||mode==6){ correct = (x==parseInt(ans,10)); }
    if(mode==2||mode==4){ correct = (x==parseInt(ans,2)); }
    if(mode==3||mode==5){ correct = (x==parseInt(ans,16)); }
  }catch(e){ correct=false; }
  return correct;
}

/* ENTER押下時 */
function enterPush(){
  if(!input.value.trim()) return;
  const correct = judgeAnswer();
  total++;
  const correctAns = correctAnswer();

  let fromBase, toBase;
  switch(mode){
    case 1: fromBase=2; toBase=10; break;
    case 2: fromBase=10; toBase=2; break;
    case 3: fromBase=2; toBase=16; break;
    case 4: fromBase=16; toBase=2; break;
    case 5: fromBase=10; toBase=16; break;
    case 6: fromBase=16; toBase=10; break;
  }

  const html = `
    ${baseLabel(fromBase)} ${formatNum(old_x, fromBase)} → ${baseLabel(toBase)} ${correctAns}<br>
    あなたの解答：<b>${escapeHtml(old_intext)}</b>
  `;

  if(correct){
    correctRate++;
    score += getPoint();
    effect("correct");
    resultBox.innerHTML = `<b style="color:green;">○ 正解！</b><br>${html}`;
  }else{
    effect("wrong");
    resultBox.innerHTML = `<b style="color:red;">× 不正解！</b><br>${html}`;
  }

  stats.textContent = `正答率: ${correctRate} / ${total}　スコア: ${Math.floor(score)}`;
  input.value="";
  old_mode = mode;
  if(set_mode==7){ mode=Math.floor(Math.random()*6)+1; } else { mode=set_mode; }
  if(levelChk.checked){
    if(Math.random()<0.05){ level_mode=3; } else { level_mode=2; } // 5%でハード
  }else{
    level_mode=1;
  }
  x_random();
  updateQuestion();
}

/* format displayed number */
function formatNum(val, base){
  if(base==2) return val.toString(2);
  if(base==10) return val.toString(10);
  if(base==16) return val.toString(16).toUpperCase();
}

/* scoring by difficulty */
function getPoint(){
  if(level_mode==1) return e_point;
  if(level_mode==2) return n_point;
  if(level_mode==3) return h_point;
  return 1;
}

/* visual effect */
function effect(type){
  resultBox.classList.remove("effect-correct","effect-wrong");
  void resultBox.offsetWidth;
  resultBox.classList.add(type==="correct"?"effect-correct":"effect-wrong");
}

/* simple HTML escape for safety */
function escapeHtml(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* event wiring */
enterBtn.addEventListener("click", enterPush);
input.addEventListener("keydown", e=>{
  if(allowNative.checked){
    if(e.key==="Enter"){ enterPush(); }
  } else {
    // native keyboard disabled: prevent typing
    e.preventDefault();
  }
});
modeSelect.addEventListener("change", ()=>{
  set_mode = parseInt(modeSelect.value);
  if(set_mode==7){mode=Math.floor(Math.random()*6)+1;}
  else{mode=set_mode;}
  x_random();
  updateQuestion();
});
levelChk.addEventListener("change", ()=>{
  level_mode = levelChk.checked ? 2 : 1;
  updateQuestion();
});

/* allowNative toggle: enable/disable native keyboard */
allowNative.addEventListener('change', ()=>{
  if(allowNative.checked){
    input.removeAttribute('readonly');
    input.focus();
  }else{
    input.setAttribute('readonly', 'true');
    input.blur();
  }
});

/* --- ソフトキーボードの処理 --- */
const kbd = document.getElementById('softKbd');
kbd.addEventListener('click', (ev)=>{
  const keyDiv = ev.target.closest('.key');
  if(!keyDiv) return;
  const k = keyDiv.dataset.key;
  if(k === undefined){
    // could be Del or Enter handled by id
    if(keyDiv.id === 'delKey'){ delChar(); }
    if(keyDiv.id === 'kbdEnter'){ enterPush(); }
    return;
  }
  insertChar(k);
});
document.getElementById('delKey').addEventListener('touchstart', (e)=>{ e.preventDefault(); delChar(); });
document.getElementById('kbdEnter').addEventListener('touchstart', (e)=>{ e.preventDefault(); enterPush(); });

/* insert character at end (uppercase) */
function insertChar(ch){
  // allow A-F only if meaningful, but we just insert uppercase
  const cur = input.value || "";
  // limit length to reasonable (e.g., 16 chars)
  if(cur.length >= 16) return;
  input.value = (cur + ch.toString().toUpperCase());
  // show caret (for some browsers)
  input.scrollLeft = input.scrollWidth;
}

/* delete last char */
function delChar(){
  input.value = (input.value || "").slice(0, -1);
}

/* init: ensure input readonly initially */
input.setAttribute('readonly','true');

/* start */
updateQuestion();

</script>
</body>
</html>
